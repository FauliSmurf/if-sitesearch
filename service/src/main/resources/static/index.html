<!DOCTYPE html>
<!--
  ~ Copyright 2017 IntraFind Software AG. All rights reserved.
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<html lang="en">
<meta charset="utf-8"/>
<meta name="description"
      content="Simple Site Search from the makers of the enterprise search vendor IntraFind Software AG.">
<title>Simple Site Search</title>
<link rel="stylesheet" type="text/css" href="https://api.sitesearch.cloud/searchbar/css/app.css"/>
<link rel="stylesheet" type="text/css" href="https://api.sitesearch.cloud/theme/font/css/font-awesome.min.css"/>
<script src="/app/runtime/kotlin.js"></script>
<script src="/app/client/client.js"></script>
<script>
    const showAuthentication = async function () {
        const xhr = new XMLHttpRequest();
        xhr.open("GET", "/user");
        xhr.onload = async function () {
            if (this.status === 200 && this.responseText === "") {
                document.getElementById("user").textContent = "";
                document.getElementById("user").display = "none";
            } else {
                const user = JSON.parse(this.responseText);
                document.getElementById("user").textContent = user.userAuthentication.details.name;
                document.getElementById("user").title = user.userAuthentication.details.id;
                document.getElementById("user").style.display = "inline";
                document.getElementById("assignmentContainer").style.display = "inline";

                document.getElementById("loginLink").style.display = "none";
                document.getElementById("logoutLink").style.display = "inline";
                document.getElementById("company").value = user.userAuthentication.details.company;
                document.getElementById("contactEmail").value = user.userAuthentication.details.email;
            }
        };
        xhr.send();
    };
    const assignSiteToTenant = async function () {
        const xhr = new XMLHttpRequest();
        xhr.open("GET", "/user");
        xhr.onload = async function () {
            if (this.status === 200 && this.responseText !== "") {
                const user = JSON.parse(this.responseText);
                const xhr = new XMLHttpRequest();
                xhr.open("PUT", "/assignments/tenants/e10011b2-7f95-49e4-a9cb-189f5f5a6654/sites/"
                    + document.getElementById("siteId").value + "?siteSecret=" + document.getElementById("siteSecret").value
                    + "&siteName=" + document.getElementById("siteName"));
                xhr.setRequestHeader("content-type", "application/json");
                xhr.onload = async function () {
                };

                xhr.send(JSON.stringify({
                    authProviderId: user.userAuthentication.details.id,
                    authProvider: "github",
                    authProviderToken: user.details.tokenValue,
                    contactEmail: document.getElementById("contactEmail").value,
                    company: document.getElementById("company").value
                }));
                showAssignments();
            }
        };
        xhr.send();
    };

    const showAssignments = async function () {
        const xhr = new XMLHttpRequest();
        xhr.open("GET", "/user");
        xhr.onload = async function () {
            if (this.status === 200 && this.responseText !== "") {
                const user = JSON.parse(this.responseText);
                const xhr = new XMLHttpRequest();
                xhr.open("GET", "/authentication-providers/github/" + user.userAuthentication.details.id + "?accessToken=" + user.details.tokenValue);
                xhr.setRequestHeader("content-type", "application/json");
                xhr.onload = async function () {
                    if (xhr.status === 200) {
                        document.getElementById("assignmentsDisplay").style.display = "block";
                        const assignments = JSON.parse(xhr.responseText);
                        assignments.tenants.forEach(function (tenant) {
                            let tenantEntry = document.createElement("li");
                            let tenantCompany = document.createElement("li");
                            let tenantContactEmail = document.createElement("li");
                            tenantEntry.textContent = "Tenant ID: " + tenant.id;
                            tenantCompany.textContent = "Company: " + tenant.company;
                            tenantContactEmail.textContent = "Contact e-mail: " + tenant["contactEmail"];
                            document.getElementById("tenantAssignments").appendChild(tenantEntry);
                            document.getElementById("tenantAssignments").appendChild(tenantCompany);
                            document.getElementById("tenantAssignments").appendChild(tenantContactEmail);

                            tenant.sites.forEach(function (site) {
                                let siteEntry = document.createElement("li");
                                siteEntry.textContent = "Site ID: " + site.id;
                                let siteSecret = document.createElement("li");
                                siteSecret.textContent = "Site Secret: " + site["secret"];
                                let siteName = document.createElement("li");
                                siteName.textContent = "Site Name: " + site.name;
                                document.getElementById("siteAssignments").appendChild(siteEntry);
                                document.getElementById("siteAssignments").appendChild(siteSecret);
                                document.getElementById("siteAssignments").appendChild(siteName);
                            });
                        });

                        for (let authProvider in assignments.authProviders) {
                            let authProviderEntry = document.createElement("li");
                            authProviderEntry.textContent = "Identity: " + assignments.authProviders[authProvider];
                            document.getElementById("identityAssignments").appendChild(authProviderEntry);
                        }
                    }
                };
                xhr.send();
            }
        };
        xhr.send();
    };
</script>
<body onload="showAuthentication()">
<h1 style="font-size: 2em;"><span class="fa fa-search"></span> Simple Site Search<sup>BETA</sup></h1>
<img src="/theme/logo.png" width="361" height="105" style="float: right;">

<br>
<span id="user" class="fa fa-sign-in"></span>
<a id="loginLink" href="/login">Login</a>
<!--<a id="loginLink" href="/login?redirect_uri=/">Login</a>-->
<!--<a id="loginLink" href="/login?redirect_uri=https://api.sitesearch.cloud/login">Login</a>-->
<!--<a id="loginLink" href="/login">Login</a>-->
<br>
<br>
<a id="logoutLink" href="/logout" style="display: none;">Sign-out</a>
<br>
<br>
<div id="assignmentContainer" style="display: none;">
    <label for="siteId">Site ID</label>
    <br>
    <input id="siteId" type="text" value="8802ac86-b493-48fb-9938-68cbfc5acd63" placeholder="Site Id"/>
    <br>
    <label for="siteSecret">Site Secret</label>
    <br>
    <input id="siteSecret" type="text" value="57f3e6e4-dba7-4edf-9628-64682cc048b9" placeholder="Site Secret"/>
    <br>
    <label for="siteName">Site Name</label>
    <br>
    <input id="siteName" type="text" value="" placeholder="Site Name"/>
    <br>
    <label for="contactEmail">Contact E-mail</label>
    <br>
    <input id="contactEmail" type="email" value="" placeholder="Contact e-mail"/>
    <br>
    <label for="company">Company</label>
    <br>
    <input id="company" type="text" value="" placeholder="Company Name"/>
    <br>
    <button id="assignSite" onclick="assignSiteToTenant()">Assign SITE to TENANT using GitHub</button>
</div>

<br>
<br>
<div id="assignmentsDisplay" style="display: none">
    <h2>Tenants</h2>
    <ul id="tenantAssignments"></ul>
    <h2>Sites</h2>
    <ul id="siteAssignments"></ul>
    <h2>Identities</h2>
    <ul id="identityAssignments"></ul>
</div>

<br>
<ul style="list-style: none; font-size: 1.5em;">
    <li><a class="fa fa-book" href="/swagger-ui.html" style="text-decoration: none;">
        API specification &amp; playground</a></li>
    <li><a class="fa fa-cog" href="sitesearch-gadget.html"
           style="text-decoration: none;">
        Getting started gadget</a></li>
    <li><a class="fa fa-cogs" href="gadget/main.xml" style="text-decoration: none;">
        Embeddable G**gle gadget</a></li>
    <li><a class="fa fa-cogs" href="sitesearch-integration.html" style="text-decoration: none;">
        Integrate into your page</a></li>
</ul>

<style>
    .if-teaser-highlight {
        font-weight: bold;
    }
</style>

<div class="container" style="margin-top:130px; width: 530px;">
    <div id="searchbar"></div>
    <div id="resultlist" style="margin-top:20px;"></div>
</div>

<script src="https://api.sitesearch.cloud/searchbar/js/app.js"></script>
<script>
    jQuery.noConflict();
    jQuery(document).ready(function ($) {
        IFS.initClient({
            sbTarget: "#searchbar",
            configurl: "searchbar-config/sitesearch-config.json",
            sitesearch: true,
            siteId: "363d50f3-17cb-4756-aeca-7d3768092ae1"
        });

        IFS.handlebars.registerHelper("formatHighlightedUrl", function (url) {
            if (typeof url !== "undefined") {
                console.warn(url);
                console.warn(decodeURIComponent(url));
                console.warn(decodeURI(url));
                return decodeURIComponent(url);
            } else {
                return "";
            }
        });
    });
</script>

<div style="float: right">
    <span class="fa fa-user-circle-o"></span> <a href="privacy.html">Privacy</a> | <span class="fa fa-gavel"></span>
    <a href="terms.html">Terms</a> | <span class="fa fa-briefcase"></span> <a href="imprint.html">Imprint</a>
</div>

<script>
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
            m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-105737954-1', 'auto');
    ga('send', 'pageview');
</script>
